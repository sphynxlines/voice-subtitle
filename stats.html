<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½¿ç”¨æŠ¥å‘Š</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #fff;
    }

    /* ç™»å½•æ¡† */
    .login-box {
      background: #16213e;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 30px;
    }

    .login-box input {
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      margin-right: 10px;
      width: 200px;
    }

    .login-box button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #27ae60;
      color: white;
      cursor: pointer;
    }

    .login-box button:hover {
      background: #2ecc71;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #16213e;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-card .number {
      font-size: 36px;
      font-weight: bold;
      color: #27ae60;
    }

    .stat-card .label {
      font-size: 14px;
      color: #888;
      margin-top: 5px;
    }

    /* å›¾è¡¨åŒºåŸŸ */
    .chart-section {
      background: #16213e;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .chart-section h2 {
      margin-bottom: 20px;
      font-size: 18px;
    }

    .chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      height: 200px;
      padding: 10px 0;
    }

    .chart-bar {
      flex: 1;
      margin: 0 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .chart-bar .bar {
      width: 100%;
      max-width: 60px;
      background: #27ae60;
      border-radius: 4px 4px 0 0;
      transition: height 0.3s;
    }

    .chart-bar .date {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }

    .chart-bar .value {
      font-size: 12px;
      color: #fff;
      margin-bottom: 5px;
    }

    /* è¡¨æ ¼ */
    .table-section {
      background: #16213e;
      padding: 20px;
      border-radius: 12px;
    }

    .table-section h2 {
      margin-bottom: 20px;
      font-size: 18px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #2a2a4a;
    }

    th {
      color: #888;
      font-weight: normal;
    }

    /* éšè—å†…å®¹ */
    .hidden {
      display: none;
    }

    /* é”™è¯¯æç¤º */
    .error {
      background: #e74c3c;
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }

    /* åŠ è½½ä¸­ */
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    /* åˆ·æ–°æŒ‰é’® */
    .refresh-btn {
      background: #16213e;
      border: 1px solid #444;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .refresh-btn:hover {
      background: #1f2b4a;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .last-updated {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- ç™»å½•æ¡† -->
    <div class="login-box" id="loginBox">
      <h1>ğŸ“Š ä½¿ç”¨æŠ¥å‘Š</h1>
      <input type="password" id="keyInput" placeholder="è¾“å…¥å¯†é’¥">
      <button onclick="loadStats()">æŸ¥çœ‹</button>
    </div>

    <!-- æŠ¥å‘Šå†…å®¹ -->
    <div id="reportContent" class="hidden">
      <div class="header">
        <h1>ğŸ“Š ä½¿ç”¨æŠ¥å‘Š</h1>
        <div>
          <span class="last-updated" id="lastUpdated"></span>
          <button class="refresh-btn" onclick="loadStats()">ğŸ”„ åˆ·æ–°</button>
        </div>
      </div>

      <div id="errorBox" class="error hidden"></div>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="number" id="totalCount">-</div>
          <div class="label">æ€»è¯·æ±‚æ•°</div>
        </div>
        <div class="stat-card">
          <div class="number" id="monthCount">-</div>
          <div class="label">æœ¬æœˆè¯·æ±‚</div>
        </div>
        <div class="stat-card">
          <div class="number" id="todayCount">-</div>
          <div class="label">ä»Šæ—¥è¯·æ±‚</div>
        </div>
        <div class="stat-card">
          <div class="number" id="todayUnique">-</div>
          <div class="label">ä»Šæ—¥ç”¨æˆ·</div>
        </div>
      </div>

      <!-- å›¾è¡¨ -->
      <div class="chart-section">
        <h2>ğŸ“ˆ æœ€è¿‘ 7 å¤©è¯·æ±‚é‡</h2>
        <div class="chart" id="chart"></div>
      </div>

      <!-- è¯¦ç»†è¡¨æ ¼ -->
      <div class="table-section">
        <h2>ğŸ“‹ è¯¦ç»†æ•°æ®</h2>
        <table>
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>è¯·æ±‚æ•°</th>
              <th>ç‹¬ç«‹ç”¨æˆ·</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let savedKey = localStorage.getItem('stats_key') || '';
    
    // å¦‚æœæœ‰ä¿å­˜çš„å¯†é’¥ï¼Œè‡ªåŠ¨åŠ è½½
    if (savedKey) {
      document.getElementById('keyInput').value = savedKey;
      loadStats();
    }

    async function loadStats() {
      const key = document.getElementById('keyInput').value;
      if (!key) {
        alert('è¯·è¾“å…¥å¯†é’¥');
        return;
      }

      // ä¿å­˜å¯†é’¥
      localStorage.setItem('stats_key', key);

      try {
        const response = await fetch(`/api/stats?key=${encodeURIComponent(key)}`);
        
        if (!response.ok) {
          if (response.status === 401) {
            showError('å¯†é’¥é”™è¯¯');
            localStorage.removeItem('stats_key');
          } else {
            showError('åŠ è½½å¤±è´¥');
          }
          return;
        }

        const data = await response.json();
        displayStats(data);
        
        // æ˜¾ç¤ºæŠ¥å‘Šï¼Œéšè—ç™»å½•æ¡†
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('reportContent').classList.remove('hidden');
        document.getElementById('errorBox').classList.add('hidden');
        
        // æ›´æ–°æ—¶é—´
        document.getElementById('lastUpdated').textContent = 
          'æ›´æ–°äº ' + new Date().toLocaleTimeString('zh-CN');

      } catch (error) {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
      }
    }

    function showError(message) {
      const errorBox = document.getElementById('errorBox');
      errorBox.textContent = message;
      errorBox.classList.remove('hidden');
    }

    function displayStats(data) {
      // æ›´æ–°å¡ç‰‡
      document.getElementById('totalCount').textContent = formatNumber(data.total);
      document.getElementById('monthCount').textContent = formatNumber(data.thisMonth);
      document.getElementById('todayCount').textContent = formatNumber(data.today);
      document.getElementById('todayUnique').textContent = formatNumber(data.todayUnique);

      // æ›´æ–°å›¾è¡¨
      const chart = document.getElementById('chart');
      chart.innerHTML = '';
      
      const maxRequests = Math.max(...data.last7Days.map(d => d.requests), 1);
      
      // åè½¬æ•°ç»„ï¼Œè®©æœ€æ–°çš„åœ¨å³è¾¹
      const sortedDays = [...data.last7Days].reverse();
      
      sortedDays.forEach(day => {
        const height = (day.requests / maxRequests) * 150;
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        bar.innerHTML = `
          <div class="value">${day.requests}</div>
          <div class="bar" style="height: ${Math.max(height, 4)}px"></div>
          <div class="date">${formatDate(day.date)}</div>
        `;
        chart.appendChild(bar);
      });

      // æ›´æ–°è¡¨æ ¼
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';
      
      data.last7Days.forEach(day => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${day.date}</td>
          <td>${day.requests}</td>
          <td>${day.uniqueUsers}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function formatNumber(num) {
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'k';
      }
      return num.toString();
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    // å›è½¦é”®åŠ è½½
    document.getElementById('keyInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        loadStats();
      }
    });
  </script>

</body>
</html>