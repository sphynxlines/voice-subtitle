# 长会话支持改进

## 主要改进

### 1. 智能 Token 刷新机制
- **之前**: 每 9 分钟强制停止并重启整个会话，导致用户体验中断
- **现在**: 
  - 每 8 分钟预防性刷新 token
  - 自动重连机制，用户无感知
  - 最多 3 次重连尝试，带指数退避
  - 检测 token 过期错误并自动恢复

### 2. 增强的错误处理
- 区分不同类型的错误（网络、麦克风、token、未知）
- Token 获取失败时自动重试（最多 3 次，带延迟）
- 限流错误时智能重试
- 更友好的错误提示信息

### 3. 连接状态可视化
- 新增连接状态指示器（绿色圆点）
  - 绿色：已连接
  - 橙色：正在重连
  - 灰色：未连接
- 实时显示会话时长（分:秒格式）
- 重连过程中显示明确的状态提示

### 4. 后端优化
- 提高速率限制：从 30 次/分钟 → 60 次/分钟
- 改进限流记录清理机制，避免内存泄漏
- 更智能的过期记录清理策略

### 5. 会话管理
- 会话时长追踪和显示
- 自动维护屏幕常亮状态
- 页面可见性变化时自动恢复屏幕常亮
- 优雅的会话停止和重启流程

## 技术细节

### Token 刷新流程
```
1. 每 8 分钟触发预防性刷新
2. 设置 autoReconnect 标志
3. 优雅停止当前会话
4. sessionStopped 事件触发
5. 检测到 autoReconnect 标志
6. 自动重新初始化并启动
7. 用户看到短暂的"正在重新连接"提示
8. 恢复正常监听状态
```

### 错误恢复机制
- Token 过期：自动重连
- 网络错误：显示错误，停止会话
- 麦克风错误：显示错误，停止会话
- 限流错误：延迟重试（1秒、2秒、3秒）

## 用户体验改进

1. **无缝长会话**: 支持连续使用数小时而不中断
2. **透明重连**: 重连过程快速且用户几乎无感知
3. **清晰反馈**: 连接状态和会话时长一目了然
4. **智能恢复**: 遇到临时问题自动恢复，无需手动干预

## 测试建议

1. 测试长时间会话（超过 30 分钟）
2. 测试网络切换场景（WiFi ↔ 移动数据）
3. 测试弱网环境下的自动重连
4. 验证 token 刷新时的用户体验
5. 检查内存使用情况（长时间运行）
